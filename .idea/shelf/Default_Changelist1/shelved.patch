Index: service/scan.php
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?php\nrequire_once '../database.php';\nrequire_once '../functions.php';\n$disk = new Disk();\n\n$templates = [\n    'moments'=>'disk:/Видео_моменты/%s',\n    'common'=>'disk:/Видео/%s',\n];\n\n//$years = range(1996, date('Y'));\nif(isset($_GET['mode'])&&$_GET['mode'] == 'light') {\n    $years = [2023];\n} else {\n    if (isset($argv[1])) {\n        $years = [$argv[1]];\n    } else {\n        $years = [1996, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023];\n    }\n}\n\n$DB = new Database();\n\n$rescan_counter = 0;\n$my_files = [];\n$errors = [];\n$Misha_bd = '2013-01-15';\n$Vera_bd  = '2016-04-19';\n$db = [];\n$total_files = 0;\n$debug = false;\nforeach ($templates as $key=> $template) {\n    if($debug) {\n        echo \"Scanning $key: \" . $template . PHP_EOL;\n    }\n    $my_files = [];\n    foreach ($years as $year) {\n\n        $param = sprintf($template, $year);\n\n        $files = $disk->getFiles(urlencode($param), 1000);\n        if($debug) {\n            echo \"Processing \" . $year . PHP_EOL;\n            echo \"<br>\";\n        }\n        foreach ($files as $resource) {\n            $date_meta = explode(' ', $resource->name)[0];\n            $date = strtotime($date_meta);\n            $filename_no_extension = pathinfo($resource->name, PATHINFO_FILENAME);\n            $filename = trim(str_replace($date_meta, '', $filename_no_extension));\n\n            $real_date = date('Y-m-d', $date);\n            if ($real_date == '1970-01-01') {\n                $errors[] = [\n                    'date' => $real_date,\n                    'path' => $resource->path,\n                ];\n            } else {\n                $date_parts = explode('-', $real_date);\n                $unique_day = str_replace($date_parts[0], '1970', $real_date);\n\n                if (!isset($resource->public_url)) {\n                    $disk->setPubicUrl(urlencode($resource->path));\n                    if($debug) {\n                        echo(\"sharing: \" . $filename);\n                        echo \"<br>\";\n                    }\n                    $rescan_counter++;\n                } else {\n                    $total_files++;\n                    $my_files[] = [\n                        'unique_date' => $unique_day,\n                        'date' => date('d.m.Y', strtotime($real_date)),\n                        'timestamp' => strtotime($real_date),\n                        'date_formatted' => date('d.m.Y', strtotime($real_date)),\n                        'path' => $resource->path,\n                        'name' => $filename,\n                        'size' => $disk->formatBytes($resource->size),\n                        'public_url' => $resource->public_url,\n                        'Misha' => dateDiff($real_date, $Misha_bd),\n                        'Vera' => dateDiff($real_date, $Vera_bd),\n                        'type'=>$key\n                    ];\n\n                    $db = [\n                        'resource_id' => $resource->md5,\n                        'unique_date' => $unique_day,\n                        'date' => date('d.m.Y', strtotime($real_date)),\n                        'timestamp' => strtotime($real_date),\n                        'date_formatted' => date('d.m.Y', strtotime($real_date)),\n                        'path' => $resource->path,\n                        'name' => $filename,\n                        'public_url' => $resource->public_url,\n                        'Misha' => dateDiff($real_date, $Misha_bd),\n                        'Vera' => dateDiff($real_date, $Vera_bd),\n                        'type'=>$key\n                    ];\n\n                    if(!$DB->getVideo($resource->md5)) {\n                        $DB->insert('videos', $db);\n                        echo \"Импортирован ресурс \" . $resource->name;\n                    } else {\n\n                    }\n                }\n            }\n        }\n    }\n    $path = \"disk:/playlist/playlist_$key.json\";\n    $upload_URL = $disk->getPlaylistUploadURL($path);\n    $upload_status = $disk->uploadPlaylist($upload_URL, json_encode($my_files, JSON_UNESCAPED_UNICODE));\n}\n\n$path = \"disk:/playlist/db.json\";\n$upload_URL = $disk->getPlaylistUploadURL($path);\n$upload_status = $disk->uploadPlaylist($upload_URL, json_encode($db, JSON_UNESCAPED_UNICODE));\n\n//Save errors\n$path = \"disk:/playlist/errors.json\";\n$upload_URL = $disk->getPlaylistUploadURL($path);\n$disk->uploadPlaylist($upload_URL, json_encode($errors, JSON_UNESCAPED_UNICODE));\n\necho \"<br>\";\necho \"БД обновлена\";\necho \"<br>\";\necho \"<a href='/service/index.php'>ОК</a>\";\necho \"<br>\";\nif($debug) {\n    echo \"Erros: \" . count($errors) . PHP_EOL;\n    echo \"Files: \" . $total_files . PHP_EOL;\n    echo \"Files to rescan: \" . $rescan_counter . PHP_EOL;\n}\n\n\n\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/service/scan.php b/service/scan.php
--- a/service/scan.php	(revision fe8572dd9f4775822fdc9926b31a83d2d07600f5)
+++ b/service/scan.php	(date 1684961170446)
@@ -98,7 +98,7 @@
 
                     if(!$DB->getVideo($resource->md5)) {
                         $DB->insert('videos', $db);
-                        echo "Импортирован ресурс " . $resource->name;
+                        echo "Импортирован ресурс " . $resource->name . PHP_EOL;
                     } else {
 
                     }
